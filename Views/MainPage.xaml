<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="YessGoFront.Views.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:YessGoFront.ViewModels"
    xmlns:models="clr-namespace:YessGoFront.Models"
    xmlns:controls="clr-namespace:YessGoFront.Views.Controls"
    xmlns:services="clr-namespace:YessGoFront.Services"
    x:DataType="viewmodels:MainPageViewModel"
    Shell.NavBarIsVisible="False"
    BackgroundColor="#F4F6F8">

    <!-- ViewModel -->
    <ContentPage.BindingContext>
        <viewmodels:MainPageViewModel />
    </ContentPage.BindingContext>

    <Grid RowDefinitions="*,Auto">

        <!-- ===== ÐŸÐ ÐžÐšÐ Ð£Ð§Ð˜Ð’ÐÐ•ÐœÐ«Ð™ ÐšÐžÐÐ¢Ð•ÐÐ¢ ===== -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Spacing="0">

                <!-- ===== Ð¨ÐÐŸÐšÐ ===== -->
                <Border StrokeThickness="0"
                        BackgroundColor="#0F6B53"
                        StrokeShape="RoundRectangle 0,0,10,10"
                        Padding="{OnPlatform Android='16,36,16,14', iOS='16,48,16,14'}">
                    <VerticalStackLayout Spacing="16">

                        <!-- ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ -->
                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12" VerticalOptions="Center">
                            <Frame Grid.Column="0"
                                   WidthRequest="56" HeightRequest="56"
                                   CornerRadius="28" Padding="0"
                                   BackgroundColor="#FFFFFF33">
                                <Image Source="profile.png" Aspect="AspectFill"/>
                            </Frame>

                            <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                <Label
                                    FontSize="20"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    Text="{Binding Source={x:Static services:AccountStore.Instance}, Path=DisplayName}" />
                                <Label
                                    FontSize="12"
                                    TextColor="#FFFFFFCC"
                                    Text="{Binding Source={x:Static services:AccountStore.Instance}, Path=Email}" />
                            </VerticalStackLayout>
                        </Grid>

                        <!-- ÐšÐ¾ÑˆÐµÐ»Ñ‘Ðº -->
                        <Frame WidthRequest="360"
                               HeightRequest="130"
                               HorizontalOptions="Center"
                               Padding="14"
                               CornerRadius="18"
                               HasShadow="True"
                               BackgroundColor="White">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnWalletTapped"/>
                            </Frame.GestureRecognizers>

                            <Grid RowDefinitions="Auto,*" ColumnDefinitions="*,Auto">
                                <Label Text="Ð’Ð°Ñˆ Ð‘Ð°Ð»Ð°Ð½Ñ"
                                       Grid.Row="0" Grid.Column="0"
                                       TextColor="#DAA520"
                                       FontSize="13"/>
                                <Button Text="Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ"
                                        Grid.Row="0" Grid.Column="1"
                                        BackgroundColor="White"
                                        TextColor="#7A7A7A"
                                        Padding="10,4"
                                        CornerRadius="10"
                                        FontSize="13"/>
                                <Grid Grid.Row="1" Grid.ColumnSpan="2"
                                      ColumnDefinitions="*,Auto"
                                      VerticalOptions="End"
                                      Padding="0,0,0,2">
                                    <HorizontalStackLayout Grid.Column="0" Spacing="8" VerticalOptions="End">
                                        <Label Text="{Binding Balance}"
                                               FontSize="30"
                                               FontAttributes="Bold"
                                               TextColor="#0F6B53"/>
                                        <Frame BackgroundColor="#EEF2F7" CornerRadius="10" Padding="8,2">
                                            <Label Text="Yess!Coin"
                                                   TextColor="#0F6B53"
                                                   FontAttributes="Bold"
                                                   FontSize="13"/>
                                        </Frame>
                                    </HorizontalStackLayout>
                                    <Image Grid.Column="1"
                                           Source="coin.png"
                                           WidthRequest="40" HeightRequest="40"
                                           HorizontalOptions="End"
                                           VerticalOptions="End"
                                           Margin="0,0,0,2"/>
                                </Grid>
                            </Grid>
                        </Frame>
                    </VerticalStackLayout>
                </Border>

                <!-- ===== ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ ÐšÐžÐÐ¢Ð•ÐÐ¢ ===== -->
                <VerticalStackLayout Spacing="16" Padding="16,12,16,20">

                    <!-- Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ -->
                    <Label Text="Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿"
                           FontAttributes="Bold"
                           FontSize="16"
                           TextColor="#333"
                           Margin="0,0,0,4"/>

                    <CollectionView ItemsSource="{Binding Stories}"
                                    ItemsLayout="HorizontalList"
                                    SelectionMode="None"
                                    HeightRequest="100"
                                    HorizontalScrollBarVisibility="Never">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:StoryModel">
                                <VerticalStackLayout Padding="4" Spacing="4" WidthRequest="80">
                                    <Border WidthRequest="64" HeightRequest="64"
                                            BackgroundColor="White"
                                            Stroke="#DAA520" StrokeThickness="2"
                                            HorizontalOptions="Center" VerticalOptions="Center">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="32"/>
                                        </Border.StrokeShape>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding BindingContext.OpenStoryAsyncCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Image Source="{Binding Icon}" Aspect="AspectFill"/>
                                    </Border>
                                    <Label Text="{Binding Title}"
                                           FontSize="12"
                                           HorizontalTextAlignment="Center"
                                           TextColor="#333"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="1"/>
                                </VerticalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Ð‘Ð°Ð½Ð½ÐµÑ€Ñ‹ -->
                    <CollectionView ItemsSource="{Binding Banners}"
                                    ItemsLayout="HorizontalList"
                                    SelectionMode="None"
                                    HeightRequest="120"
                                    HorizontalScrollBarVisibility="Never">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:BannerModel">
                                <Frame CornerRadius="16" Padding="0" HasShadow="True" Margin="0,0,12,0">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding BindingContext.OpenBannerAsyncCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding .}" />
                                    </Frame.GestureRecognizers>
                                    <Image Source="{Binding Image}" Aspect="AspectFill"/>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- ===== ÐÐ°ÑˆÐ¸ Ð¿Ð°Ñ€Ñ‚Ð½Ñ‘Ñ€Ñ‹ ===== -->
                    <Label Text="ÐÐ°ÑˆÐ¸ Ð¿Ð°Ñ€Ñ‚Ð½Ñ‘Ñ€Ñ‹"
                           FontAttributes="Bold"
                           FontSize="16"
                           TextColor="#555"
                           Margin="0,2,0,0"/>

                    <!-- ðŸ”¹ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð±Ð»Ð¾Ðº -->
                    <VerticalStackLayout Spacing="0" Padding="0" Margin="0">

                        <!-- Ð ÑÐ´ 1 -->
                        <ScrollView x:Name="Row1"
                                    Orientation="Horizontal"
                                    HeightRequest="98"
                                    HorizontalScrollBarVisibility="Never">
                            <HorizontalStackLayout x:Name="Row1Panel"
                                                   Spacing="20"
                                                   Padding="24,0"
                                                   BindableLayout.ItemsSource="{Binding PartnersRow1}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:PartnerLogoModel">
                                        <Border WidthRequest="84" HeightRequest="84"
                                                Padding="0"
                                                BackgroundColor="White"
                                                Stroke="#0F6B53"
                                                StrokeThickness="1">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="42"/>
                                            </Border.StrokeShape>
                                            <Image Source="{Binding Logo}" Aspect="AspectFill"/>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                        </ScrollView>

                        <!-- Ð ÑÐ´ 2 -->
                        <ScrollView x:Name="Row2"
                                    Orientation="Horizontal"
                                    HeightRequest="98"
                                    HorizontalScrollBarVisibility="Never">
                            <HorizontalStackLayout x:Name="Row2Panel"
                                                   Spacing="20"
                                                   Padding="24,0"
                                                   BindableLayout.ItemsSource="{Binding PartnersRow2}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:PartnerLogoModel">
                                        <Border WidthRequest="84" HeightRequest="84"
                                                Padding="0"
                                                BackgroundColor="White"
                                                Stroke="#0F6B53"
                                                StrokeThickness="1">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="42"/>
                                            </Border.StrokeShape>
                                            <Image Source="{Binding Logo}" Aspect="AspectFill"/>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                        </ScrollView>

                        <!-- Ð ÑÐ´ 3 -->
                        <ScrollView x:Name="Row3"
                                    Orientation="Horizontal"
                                    HeightRequest="98"
                                    HorizontalScrollBarVisibility="Never">
                            <HorizontalStackLayout x:Name="Row3Panel"
                                                   Spacing="20"
                                                   Padding="24,0"
                                                   BindableLayout.ItemsSource="{Binding PartnersRow3}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:PartnerLogoModel">
                                        <Border WidthRequest="84" HeightRequest="84"
                                                Padding="0"
                                                BackgroundColor="White"
                                                Stroke="#0F6B53"
                                                StrokeThickness="1">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="42"/>
                                            </Border.StrokeShape>
                                            <Image Source="{Binding Logo}" Aspect="AspectFill"/>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                        </ScrollView>

                    </VerticalStackLayout>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>

        <!-- ===== ÐÐ˜Ð–ÐÐ˜Ð™ ÐÐÐ’Ð‘ÐÐ  ===== -->
        <controls:BottomNavBar x:Name="BottomBar" Grid.Row="1" />

        <!-- ====== OVERLAY: Story (full-screen) ====== -->
        <Grid Grid.RowSpan="2"
              IsVisible="{Binding IsStoryOpen}"
              BackgroundColor="#000000CC"
              InputTransparent="False"
              ZIndex="9999">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ -->
            <Grid Grid.Row="0" Padding="0" Margin="0">
                <FlexLayout Direction="Row"
                            AlignItems="Center"
                            JustifyContent="SpaceBetween"
                            BindableLayout.ItemsSource="{Binding PageProgressList}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="x:Double">
                            <Grid HeightRequest="4" Margin="2,0" HorizontalOptions="FillAndExpand">
                                <BoxView HeightRequest="4" Color="#FFFFFF55"/>
                                <ProgressBar Progress="{Binding ., TargetNullValue=0, FallbackValue=0}"
                                             HeightRequest="4"
                                             ProgressColor="White"
                                             BackgroundColor="Transparent"/>
                            </Grid>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </FlexLayout>
            </Grid>

            <!-- Ð¡Ñ†ÐµÐ½Ð° ÑÑ‚Ð¾Ñ€Ð¸Ñ -->
            <Grid Grid.Row="1">
                <Image x:Name="StoryImageA" Aspect="AspectFill" Opacity="1"/>
                <Image x:Name="StoryImageB" Aspect="AspectFill" Opacity="0"/>

                <!-- ÐŸÐ¾Ð´Ð¿Ð¸ÑÑŒ ÑÑ‚Ð¾Ñ€Ð¸Ñ -->
                <HorizontalStackLayout Spacing="10"
                                       Padding="16,44,16,0"
                                       HorizontalOptions="Start"
                                       VerticalOptions="Start"
                                       InputTransparent="True">

                    <Border WidthRequest="42" HeightRequest="42"
                            Stroke="White" StrokeThickness="1.5"
                            BackgroundColor="Transparent"
                            HorizontalOptions="Start"
                            VerticalOptions="Center">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="21" />
                        </Border.StrokeShape>
                        <Image Source="{Binding CurrentStory.Icon}"
                               Aspect="AspectFill" />
                    </Border>

                    <Label Text="{Binding CurrentStory.Title}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="White"
                           VerticalOptions="Center">
                        <Label.Shadow>
                            <Shadow Brush="#000000"
                                    Opacity="0.7"
                                    Radius="4"
                                    Offset="1,1"/>
                        </Label.Shadow>
                    </Label>
                </HorizontalStackLayout>

                <!-- ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ ÑÑ‚Ð¾Ñ€Ð¸Ñ -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid Grid.Column="0">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PrevPageCommand}"/>
                        </Grid.GestureRecognizers>
                    </Grid>
                    <Grid Grid.Column="1">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NextPageCommand}"/>
                        </Grid.GestureRecognizers>
                    </Grid>
                </Grid>

                <Image Source="{Binding CurrentPageImage}"
                       Aspect="AspectFill"
                       HorizontalOptions="Fill"
                       VerticalOptions="Fill"
                       InputTransparent="True"/>
            </Grid>
        </Grid>

        <!-- ====== OVERLAY: Banner (full-screen) ====== -->
        <Grid Grid.RowSpan="2"
              IsVisible="{Binding IsBannerOpen}"
              BackgroundColor="#000000CC"
              ZIndex="10000">
            <Image Source="{Binding CurrentBanner.Image}"
                   Aspect="AspectFill"
                   HorizontalOptions="Fill"
                   VerticalOptions="Fill"/>
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseBannerCommand}"/>
            </Grid.GestureRecognizers>
        </Grid>

    </Grid>
</ContentPage>
